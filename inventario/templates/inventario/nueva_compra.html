{% extends 'base.html' %}
{% block title %}Nueva Compra - MISHI{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex;
        justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    }
    .page-header h2 { color: #2c3e50; margin: 0; display: flex; align-items: center; gap: 10px; }
    .compra-layout { display: grid; grid-template-columns: 1fr 420px; gap: 25px; align-items: start; }
    .card-section { background: white; border-radius: 15px; padding: 28px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 22px; }
    .card-section:last-child { margin-bottom: 0; }
    .card-section h5 { color: #2c3e50; margin: 0 0 20px 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; padding-bottom: 14px; border-bottom: 2px solid #f0f0f0; }
    .form-group { display: flex; flex-direction: column; gap: 7px; margin-bottom: 18px; }
    .form-group label { color: #495057; font-weight: 500; font-size: 0.88rem; display: flex; align-items: center; gap: 6px; }
    .form-control { padding: 11px 14px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.92rem; transition: all 0.25s; color: #2c3e50; width: 100%; box-sizing: border-box; background: white; }
    .form-control:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.12); }
    .form-control:disabled { background: #f8f9fa; color: #adb5bd; cursor: not-allowed; }
    .proveedor-lock-msg { display: none; align-items: center; gap: 7px; font-size: 0.82rem; color: #856404; background: #fff8e1; border: 1.5px solid #ffe082; border-radius: 8px; padding: 8px 12px; margin-top: 6px; }
    .proveedor-lock-msg.visible { display: flex; }

    /* Search – igual al de ventas */
    .search-wrapper { position: relative; }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #adb5bd; font-size: 1rem; pointer-events: none; }
    .search-input { width: 100%; padding: 13px 15px 13px 42px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 0.95rem; transition: all 0.3s; color: #2c3e50; box-sizing: border-box; background: white; }
    .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .search-input::placeholder { color: #adb5bd; }
    .search-results { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: white; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); z-index: 200; max-height: 260px; overflow-y: auto; display: none; border: 1px solid #e9ecef; }
    .search-results.open { display: block; }
    .search-result-item { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; transition: background 0.15s; border-bottom: 1px solid #f8f9fa; cursor: pointer; }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: #f0f2ff; }
    .result-nombre { font-weight: 600; color: #2c3e50; font-size: 0.9rem; }
    .result-codigo { font-size: 0.75rem; color: #adb5bd; margin-top: 2px; }
    .result-precio { font-weight: 700; color: #667eea; font-size: 0.9rem; white-space: nowrap; }
    .result-empty  { padding: 20px; text-align: center; color: #adb5bd; font-size: 0.9rem; }

    .input-divider { display: flex; align-items: center; gap: 12px; margin: 14px 0; color: #adb5bd; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .input-divider::before, .input-divider::after { content: ''; flex: 1; height: 1px; background: #e9ecef; }

    .sin-proveedor-msg { text-align: center; padding: 24px 16px; color: #adb5bd; font-size: 0.9rem; }
    .sin-proveedor-msg i { font-size: 1.8rem; display: block; margin-bottom: 8px; }

    /* Tabla */
    .tabla-compra { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
    .tabla-compra thead th { background: #f8f9fa; padding: 10px 12px; text-align: left; font-weight: 600; color: #495057; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e9ecef; }
    .tabla-compra tbody td { padding: 11px 12px; border-bottom: 1px solid #f0f0f0; color: #2c3e50; vertical-align: middle; }
    .tabla-compra tbody tr:last-child td { border-bottom: none; }
    .tabla-compra tbody tr:hover td { background: #f8f9ff; }
    .qty-control { display: flex; align-items: center; gap: 6px; }
    .qty-btn { width: 28px; height: 28px; border-radius: 6px; border: 1.5px solid #e9ecef; background: white; color: #495057; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; font-weight: 700; line-height: 1; }
    .qty-btn:hover { border-color: #667eea; color: #667eea; background: #f0f4ff; }
    .qty-input { width: 52px; padding: 5px 8px; border: 1.5px solid #e9ecef; border-radius: 6px; font-size: 0.88rem; text-align: center; color: #2c3e50; }
    .qty-input:focus { outline: none; border-color: #667eea; }
    .precio-input { width: 90px; padding: 5px 8px; border: 1.5px solid #e9ecef; border-radius: 6px; font-size: 0.88rem; color: #2c3e50; }
    .precio-input:focus { outline: none; border-color: #667eea; }
    .btn-remove { background: none; border: none; color: #ef5350; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.15s; font-size: 1rem; }
    .btn-remove:hover { background: #fdecea; }
    .tabla-empty { padding: 30px; text-align: center; color: #adb5bd; font-size: 0.9rem; }

    /* Sidebar */
    .sidebar-resumen { background: white; border-radius: 15px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 20px; }
    .sidebar-resumen h6 { color: #2c3e50; font-size: 0.9rem; font-weight: 600; margin: 0 0 18px 0; display: flex; align-items: center; gap: 7px; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0; }
    .resumen-row { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.88rem; color: #495057; }
    .resumen-row:last-of-type { border-bottom: none; }
    .resumen-row .val { font-weight: 700; color: #2c3e50; }
    .resumen-total { margin-top: 14px; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; justify-content: space-between; align-items: center; color: white; }
    .resumen-total .lbl { font-size: 0.9rem; font-weight: 600; opacity: 0.85; }
    .resumen-total .monto { font-size: 1.5rem; font-weight: 800; }
    .btn-submit { width: 100%; margin-top: 16px; padding: 13px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-submit:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-back { padding: 10px 20px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .btn-back:hover { background: #667eea; color: white; }

    @media (max-width: 992px) { .compra-layout { grid-template-columns: 1fr; } .sidebar-resumen { position: static; } }
    @media (max-width: 600px) { .page-header { padding: 16px; } .card-section { padding: 16px; } .btn-back { width: 100%; justify-content: center; } }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="page-header">
        <h2><i class="bi bi-cart-plus"></i> Nueva Compra</h2>
        <a href="{% url 'lista_compras' %}" class="btn-back">
            <i class="bi bi-arrow-left"></i> Volver a Compras
        </a>
    </div>

    <form method="POST" action="{% url 'guardar_compra' %}" id="formCompra">
        {% csrf_token %}
        <input type="hidden" name="data_compra" id="dataCompraInput">

        <div class="compra-layout">
            <div>

                <!-- Proveedor -->
                <div class="card-section">
                    <h5><i class="bi bi-truck"></i> Proveedor</h5>
                    <div class="form-group" style="margin-bottom:8px;">
                        <label for="proveedorSelect">
                            <i class="bi bi-building"></i>
                            Selecciona un proveedor <span style="color:#dc3545;">*</span>
                        </label>
                        <select id="proveedorSelect" name="proveedor" class="form-control" required>
                            <option value="">— Elige un proveedor —</option>
                            {% for proveedor in proveedores %}
                            <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="proveedor-lock-msg" id="proveedorLockMsg">
                            <i class="bi bi-lock-fill"></i>
                            Proveedor bloqueado — ya hay productos en la lista. Elimínalos todos para cambiarlo.
                        </div>
                    </div>
                </div>

                <!-- Buscador -->
                <div class="card-section">
                    <h5><i class="bi bi-search"></i> Agregar Productos</h5>

                    <div class="sin-proveedor-msg" id="sinProveedorMsg">
                        <i class="bi bi-arrow-up-circle"></i>
                        Primero selecciona un proveedor
                    </div>

                    <div id="buscadoresBox" style="display:none;">
                        <!-- Código de barras -->
                        <div class="search-wrapper" style="margin-bottom:0;">
                            <i class="bi bi-upc-scan search-icon"></i>
                            <input type="text" id="codigoInput" class="search-input"
                                placeholder="Escanea un código de barras y presiona Enter...">
                        </div>

                        <div class="input-divider">o busca por nombre</div>

                        <!-- Búsqueda en vivo -->
                        <div class="search-wrapper">
                            <i class="bi bi-box-seam search-icon"></i>
                            <input type="text" id="nombreInput" class="search-input"
                                placeholder="Escribe el nombre del producto..." autocomplete="off">
                            <div class="search-results" id="searchResults"></div>
                        </div>
                    </div>
                </div>

                <!-- Tabla -->
                <div class="card-section">
                    <h5>
                        <i class="bi bi-list-check"></i> Productos en esta Compra
                        <span id="contadorProductos" style="margin-left:auto; background:#667eea1a; color:#667eea; font-size:0.78rem; padding:3px 10px; border-radius:20px; font-weight:700;">0 productos</span>
                    </h5>
                    <div class="tabla-empty" id="tablaEmpty">
                        <i class="bi bi-inbox" style="font-size:2rem; display:block; margin-bottom:8px; opacity:.4;"></i>
                        Aún no hay productos agregados
                    </div>
                    <table class="tabla-compra" id="tablaCompra" style="display:none;">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Compra</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody"></tbody>
                    </table>
                </div>

            </div>

            <!-- Sidebar -->
            <div class="sidebar-resumen">
                <h6><i class="bi bi-receipt"></i> Resumen de Compra</h6>
                <div class="resumen-row"><span>Proveedor</span><span class="val" id="resumenProveedor">—</span></div>
                <div class="resumen-row"><span>Productos distintos</span><span class="val" id="resumenProductos">0</span></div>
                <div class="resumen-row"><span>Total unidades</span><span class="val" id="resumenUnidades">0</span></div>
                <div class="resumen-total">
                    <span class="lbl">Total</span>
                    <span class="monto" id="resumenTotal">$0.00</span>
                </div>
                <button type="submit" class="btn-submit" id="btnGuardar" disabled>
                    <i class="bi bi-check-circle"></i> Guardar Compra
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ── Normalización ────────────────────────────────────────────────────────────
function norm(str) {
    return (str || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

// ── Estado ───────────────────────────────────────────────────────────────────
let productosEnLista      = [];
let productosDelProveedor = [];
let proveedorBloqueado    = false;

// ── Elementos ─────────────────────────────────────────────────────────────────
const proveedorSelect   = document.getElementById('proveedorSelect');
const proveedorLockMsg  = document.getElementById('proveedorLockMsg');
const sinProveedorMsg   = document.getElementById('sinProveedorMsg');
const buscadoresBox     = document.getElementById('buscadoresBox');
const codigoInput       = document.getElementById('codigoInput');
const nombreInput       = document.getElementById('nombreInput');
const searchResults     = document.getElementById('searchResults');
const tablaCompra       = document.getElementById('tablaCompra');
const tablaBody         = document.getElementById('tablaBody');
const tablaEmpty        = document.getElementById('tablaEmpty');
const contadorProductos = document.getElementById('contadorProductos');
const btnGuardar        = document.getElementById('btnGuardar');
const dataCompraInput   = document.getElementById('dataCompraInput');

// ── Proveedor ────────────────────────────────────────────────────────────────
proveedorSelect.addEventListener('change', async function () {
    const id = this.value;
    productosDelProveedor = [];
    searchResults.classList.remove('open');
    nombreInput.value = '';

    if (!id) {
        buscadoresBox.style.display = 'none';
        sinProveedorMsg.style.display = 'block';
        actualizarResumen();
        return;
    }

    sinProveedorMsg.style.display = 'none';
    buscadoresBox.style.display   = 'block';
    codigoInput.focus();

    try {
        const resp = await fetch(`/inventario/productos-por-proveedor/${id}/`);
        const data = await resp.json();
        productosDelProveedor = data.productos || [];
        console.log('Productos cargados:', productosDelProveedor.length, productosDelProveedor);
    } catch(e) {
        console.error('Error cargando productos:', e);
        productosDelProveedor = [];
    }

    actualizarResumen();
});

// ── Escáner código de barras ─────────────────────────────────────────────────
codigoInput.addEventListener('keypress', function (e) {
    if (e.key !== 'Enter') return;
    
    e.preventDefault(); // ✅ Evita que el formulario se envíe
    
    const codigo = this.value.trim();
    if (!codigo) return;

    const prod = productosDelProveedor.find(p => p.codigo && norm(p.codigo) === norm(codigo));

    if (prod) {
        agregarProducto(prod);
        this.style.borderColor = '#2e7d32';
        setTimeout(() => { this.style.borderColor = ''; }, 700);
    } else {
        this.style.borderColor = '#dc3545';
        this.style.boxShadow = '0 0 0 3px rgba(220,53,69,0.15)';
        setTimeout(() => { this.style.borderColor = ''; this.style.boxShadow = ''; }, 900);
    }
    this.value = '';
});

// ── Búsqueda en vivo por nombre ───────────────────────────────────────────────
nombreInput.addEventListener('input', function () {
    const q = norm(this.value);

    if (!q) {
        searchResults.classList.remove('open');
        searchResults.innerHTML = '';
        return;
    }

    const palabras = q.split(' ').filter(Boolean);
    const matches  = productosDelProveedor.filter(p => {
        const n = norm(p.nombre);
        return palabras.every(pal => n.includes(pal));
    }).slice(0, 8);

    if (matches.length === 0) {
        searchResults.innerHTML = '<div class="result-empty"><i class="bi bi-search"></i> Sin resultados</div>';
    } else {
        searchResults.innerHTML = matches.map(p => `
            <div class="search-result-item" onclick="seleccionarProducto(${p.id})">
                <div>
                    <div class="result-nombre">${p.nombre}</div>
                    ${p.codigo ? `<div class="result-codigo"><i class="bi bi-upc-scan"></i> ${p.codigo}</div>` : ''}
                </div>
                <div class="result-precio">$${parseFloat(p.precio_compra).toFixed(2)}</div>
            </div>`).join('');
    }

    searchResults.classList.add('open');
});

document.addEventListener('click', function (e) {
    if (!nombreInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.remove('open');
    }
});

function seleccionarProducto(id) {
    const prod = productosDelProveedor.find(p => p.id === id);
    if (prod) agregarProducto(prod);
    nombreInput.value = '';
    searchResults.classList.remove('open');
    nombreInput.focus();
}

// ── Agregar producto ──────────────────────────────────────────────────────────
function agregarProducto(producto) {
    const existente = productosEnLista.find(p => p.id === producto.id);
    if (existente) {
        existente.cantidad += 1;
    } else {
        productosEnLista.push({
            id:       producto.id,
            nombre:   producto.nombre,
            codigo:   producto.codigo || '',
            cantidad: 1,
            precio:   parseFloat(producto.precio_compra)
        });
        bloquearProveedor();
    }
    renderTabla();
    actualizarResumen();
}

// ── Render tabla ──────────────────────────────────────────────────────────────
function renderTabla() {
    tablaBody.innerHTML = '';

    if (!productosEnLista.length) {
        tablaCompra.style.display = 'none';
        tablaEmpty.style.display  = 'block';
        contadorProductos.textContent = '0 productos';
        return;
    }

    tablaCompra.style.display = 'table';
    tablaEmpty.style.display  = 'none';
    contadorProductos.textContent = `${productosEnLista.length} producto${productosEnLista.length !== 1 ? 's' : ''}`;

    productosEnLista.forEach((p, idx) => {
        const subtotal = (p.cantidad * p.precio).toFixed(2);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div style="font-weight:600; color:#2c3e50;">${p.nombre}</div>
                ${p.codigo ? `<div style="font-size:0.75rem; color:#adb5bd;"><i class="bi bi-upc-scan"></i> ${p.codigo}</div>` : ''}
            </td>
            <td>
                <div class="qty-control">
                    <button type="button" class="qty-btn" onclick="cambiarCantidad(${idx}, -1)">−</button>
                    <input type="number" class="qty-input" min="1" value="${p.cantidad}"
                        onchange="setCantidad(${idx}, this.value)">
                    <button type="button" class="qty-btn" onclick="cambiarCantidad(${idx}, 1)">+</button>
                </div>
            </td>
            <td>
                <div style="display:flex; align-items:center; gap:4px;">
                    <span style="color:#6c757d; font-weight:600;">$</span>
                    <input type="number" class="precio-input" min="0" step="0.01"
                        value="${p.precio.toFixed(2)}" onchange="setPrecio(${idx}, this.value)">
                </div>
            </td>
            <td style="font-weight:700; color:#667eea;">$${subtotal}</td>
            <td>
                <button type="button" class="btn-remove" onclick="eliminarProducto(${idx})">
                    <i class="bi bi-trash3"></i>
                </button>
            </td>`;
        tablaBody.appendChild(tr);
    });
}

// ── Controles tabla ───────────────────────────────────────────────────────────
function cambiarCantidad(idx, delta) { productosEnLista[idx].cantidad = Math.max(1, productosEnLista[idx].cantidad + delta); renderTabla(); actualizarResumen(); }
function setCantidad(idx, val) { const n = parseInt(val); productosEnLista[idx].cantidad = isNaN(n)||n<1?1:n; renderTabla(); actualizarResumen(); }
function setPrecio(idx, val) { const n = parseFloat(val); productosEnLista[idx].precio = isNaN(n)||n<0?0:n; actualizarResumen(); }
function eliminarProducto(idx) { productosEnLista.splice(idx,1); if(!productosEnLista.length) desbloquearProveedor(); renderTabla(); actualizarResumen(); }

// ── Bloqueo proveedor ─────────────────────────────────────────────────────────
function bloquearProveedor() {
    if (proveedorBloqueado) return;
    proveedorBloqueado = true;
    proveedorSelect.disabled = true;

    // ✅ Hidden input para que el valor se envíe aunque el select esté disabled
    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = 'proveedor';
    hidden.id = 'proveedorHidden';
    hidden.value = proveedorSelect.value;
    proveedorSelect.removeAttribute('name');
    proveedorSelect.parentNode.appendChild(hidden);

    proveedorLockMsg.classList.add('visible');
}
function desbloquearProveedor() {
    proveedorBloqueado = false;
    proveedorSelect.disabled = false;
    proveedorSelect.name = 'proveedor';

    const hidden = document.getElementById('proveedorHidden');
    if (hidden) hidden.remove();

    proveedorLockMsg.classList.remove('visible');
}

// ── Resumen ───────────────────────────────────────────────────────────────────
function actualizarResumen() {
    const totalUnidades = productosEnLista.reduce((s,p) => s+p.cantidad, 0);
    const totalMonto    = productosEnLista.reduce((s,p) => s+p.cantidad*p.precio, 0);
    const provText      = proveedorSelect.options[proveedorSelect.selectedIndex]?.text || '—';
    document.getElementById('resumenProveedor').textContent = proveedorSelect.value ? provText : '—';
    document.getElementById('resumenProductos').textContent = productosEnLista.length;
    document.getElementById('resumenUnidades').textContent  = totalUnidades;
    document.getElementById('resumenTotal').textContent     = '$' + totalMonto.toFixed(2);
    btnGuardar.disabled = !(proveedorSelect.value && productosEnLista.length > 0);
    dataCompraInput.value = JSON.stringify(productosEnLista.map(p => ({id:p.id, cantidad:p.cantidad, precio:p.precio.toFixed(2)})));
}
</script>
{% endblock %}